USE [AprosysAccounting]
GO
/****** Object:  StoredProcedure [dbo].[Report_MonthlySubscription]    Script Date: 2/15/2019 4:51:37 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER procedure [dbo].[Report_MonthlySubscription]
(
	@year int
)
AS
BEGIN

SELECT
	CST.[Id] , CST.[lastName] + ' '+CST.[FirstName] AS FirstName,
	SUBS.DueDate,SUBS.SubscriptionAmount,
	ISNULL(SUM(TBLDUE.[JAN]),0) AS JANDUE, ISNULL(SUM(TBLPAID.[JAN]),0) AS JANPAID, 
	ISNULL(SUM(TBLDUE.FEB),0) AS FEBDUE, ISNULL(SUM(TBLPAID.[FEB]),0) AS FEBPAID,
	ISNULL(SUM(TBLDUE.[MAR]),0) AS MARDUE, ISNULL(SUM(TBLPAID.[MAR]),0) AS MARPAID,
	ISNULL(SUM(TBLDUE.[APR]),0) AS APRDUE, ISNULL(SUM(TBLPAID.[APR]),0) AS APRPAID,
	ISNULL(SUM(TBLDUE.[MAY]),0) AS MAYDUE, ISNULL(SUM(TBLPAID.[MAY]),0) AS MAYPAID,
	ISNULL(SUM(TBLDUE.[JUN]),0) AS JUNDUE, ISNULL(SUM(TBLPAID.[JUN]),0) AS JUNPAID,
	ISNULL(SUM(TBLDUE.[JUL]),0) AS JULDUE, ISNULL(SUM(TBLPAID.[JUL]),0) AS JULPAID,
	ISNULL(SUM(TBLDUE.[AUG]),0) AS AUGDUE, ISNULL(SUM(TBLPAID.[AUG]),0) AS AUGPAID,
	ISNULL(SUM(TBLDUE.[SEP]),0) AS SEPDUE, ISNULL(SUM(TBLPAID.[SEP]),0) AS SEPPAID,
	ISNULL(SUM(TBLDUE.[OCT]),0) AS OCTDUE, ISNULL(SUM(TBLPAID.[OCT]),0) AS OCTPAID,
	ISNULL(SUM(TBLDUE.[NOV]),0) AS NOVDUE, ISNULL(SUM(TBLPAID.[NOV]),0) AS NOVPAID,
	ISNULL(SUM(TBLDUE.[DEC]),0) AS DECDUE, ISNULL(SUM(TBLPAID.[DEC]),0) AS DECPAID,
	ISNULL(SUM(TBLDUE.[TOTDUE]),0) AS TOTDUE, ISNULL(SUM(TBLPAID.[TOTPAID]),0) AS TOTPAID
FROM
(
SELECT 
	'PAID' AS TYPED, SUBDUE.[Id] ,SUBDUE.FirstName,
	ISNULL(SUM(SUBDUE.[JAN]),0) AS [JAN],
	ISNULL(SUM(SUBDUE.[FEB] ),0) AS [FEB],
	ISNULL(SUM(SUBDUE.MAR),0) AS MAR,
	ISNULL(SUM(SUBDUE.APR),0) AS APR,
	ISNULL(SUM(SUBDUE.MAY),0) AS MAY,
	ISNULL(SUM(SUBDUE.JUN),0) AS JUN,
	ISNULL(SUM(SUBDUE.JUL),0) AS JUL,
	ISNULL(SUM(SUBDUE.AUG),0) AS AUG,
	ISNULL(SUM(SUBDUE.SEP),0) AS SEP,
	ISNULL(SUM(SUBDUE.OCT),0) AS OCT,
	ISNULL(SUM(SUBDUE.NOV),0) AS NOV,
	ISNULL(SUM(SUBDUE.[DEC]),0) AS [DEC],
	ISNULL(SUM(SUBDUE.TOTPAID),0) AS TOTPAID
FROM
	(

SELECT
	'PAID' AS TYPED, 
	CST.[Id] ,CST.[FirstName],--SUBS.DueDate,SUBS.SubscriptionAmount, 
	CASE WHEN DATEPART(MONTH,GL.[ActivityTimestamp]) =1 THEN SUM(GL.[Debit]) ELSE 0 END AS 'JAN' ,
	CASE WHEN DATEPART(MONTH,GL.[ActivityTimestamp]) =2 THEN SUM(GL.[Debit]) ELSE 0 END AS 'FEB' ,
	CASE WHEN DATEPART(MONTH,GL.[ActivityTimestamp]) =3 THEN SUM(GL.[Debit]) ELSE 0 END AS 'MAR' ,
	CASE WHEN DATEPART(MONTH,GL.[ActivityTimestamp]) =4 THEN SUM(GL.[Debit]) ELSE 0 END AS 'APR' ,
	CASE WHEN DATEPART(MONTH,GL.[ActivityTimestamp]) =5 THEN SUM(GL.[Debit]) ELSE 0 END AS 'MAY' ,
	CASE WHEN DATEPART(MONTH,GL.[ActivityTimestamp]) =6 THEN SUM(GL.[Debit]) ELSE 0 END AS 'JUN' ,
	CASE WHEN DATEPART(MONTH,GL.[ActivityTimestamp]) =7 THEN SUM(GL.[Debit]) ELSE 0 END AS 'JUL' ,
	CASE WHEN DATEPART(MONTH,GL.[ActivityTimestamp]) =8 THEN SUM(GL.[Debit]) ELSE 0 END AS 'AUG' ,
	CASE WHEN DATEPART(MONTH,GL.[ActivityTimestamp]) =9 THEN SUM(GL.[Debit]) ELSE 0 END AS 'SEP' ,
	CASE WHEN DATEPART(MONTH,GL.[ActivityTimestamp]) =10 THEN SUM(GL.[Debit]) ELSE 0 END AS 'OCT' ,
	CASE WHEN DATEPART(MONTH,GL.[ActivityTimestamp]) =11 THEN SUM(GL.[Debit]) ELSE 0 END AS 'NOV' ,
	CASE WHEN DATEPART(MONTH,GL.[ActivityTimestamp]) =12 THEN SUM(GL.[Debit]) ELSE 0 END AS 'DEC',
	SUM(GL.[Debit]) AS TOTPAID
FROM 
	[Acc_GL] AS GL
INNER JOIN [Customer] AS CST ON CST.[Id] = GL.[CustId] AND CST.[TypeId] = 2
WHERE
	GL.[CoaId] = 11 AND GL.[TranTypeId] = 3 AND GL.[IsPostpaid] = 1 AND GL.[IsActive] = 1
	AND DATEPART(YEAR,GL.[ActivityTimestamp]) = @year
GROUP BY
	CST.[Id] ,CST.[FirstName],DATEPART(MONTH,GL.[ActivityTimestamp])
) AS SUBDUE
GROUP BY
SUBDUE.[Id] ,SUBDUE.FirstName
) AS TBLPAID
RIGHT JOIN
(
SELECT 
	'DUE' AS TYPED, SUBDUE.[Id] ,SUBDUE.FirstName,
	ISNULL(SUM(SUBDUE.[JAN]),0) AS [JAN],
	ISNULL(SUM(SUBDUE.[FEB] ),0) AS [FEB],
	ISNULL(SUM(SUBDUE.MAR),0) AS MAR,
	ISNULL(SUM(SUBDUE.APR),0) AS APR,
	ISNULL(SUM(SUBDUE.MAY),0) AS MAY,
	ISNULL(SUM(SUBDUE.JUN),0) AS JUN,
	ISNULL(SUM(SUBDUE.JUL),0) AS JUL,
	ISNULL(SUM(SUBDUE.AUG),0) AS AUG,
	ISNULL(SUM(SUBDUE.SEP),0) AS SEP,
	ISNULL(SUM(SUBDUE.OCT),0) AS OCT,
	ISNULL(SUM(SUBDUE.NOV),0) AS NOV,
	ISNULL(SUM(SUBDUE.[DEC]),0) AS [DEC],
	ISNULL(SUM(SUBDUE.TOTDUE),0) AS TOTDUE
FROM
	(
SELECT
	
	CST.[Id] ,CST.[LastName]+' '+CST.[FirstName] AS FirstName,--SUBS.DueDate,SUBS.SubscriptionAmount, 
	CASE WHEN DATEPART(MONTH,GL.[SubscriptionDueDate]) =1 THEN SUM(GL.[Debit]) ELSE 0 END AS 'JAN' ,
	CASE WHEN DATEPART(MONTH,GL.[SubscriptionDueDate]) =2 THEN SUM(GL.[Debit]) ELSE 0 END AS 'FEB' ,
	CASE WHEN DATEPART(MONTH,GL.[SubscriptionDueDate]) =3 THEN SUM(GL.[Debit]) ELSE 0 END AS 'MAR' ,
	CASE WHEN DATEPART(MONTH,GL.[SubscriptionDueDate]) =4 THEN SUM(GL.[Debit]) ELSE 0 END AS 'APR' ,
	CASE WHEN DATEPART(MONTH,GL.[SubscriptionDueDate]) =5 THEN SUM(GL.[Debit]) ELSE 0 END AS 'MAY' ,
	CASE WHEN DATEPART(MONTH,GL.[SubscriptionDueDate]) =6 THEN SUM(GL.[Debit]) ELSE 0 END AS 'JUN' ,
	CASE WHEN DATEPART(MONTH,GL.[SubscriptionDueDate]) =7 THEN SUM(GL.[Debit]) ELSE 0 END AS 'JUL' ,
	CASE WHEN DATEPART(MONTH,GL.[SubscriptionDueDate]) =8 THEN SUM(GL.[Debit]) ELSE 0 END AS 'AUG' ,
	CASE WHEN DATEPART(MONTH,GL.[SubscriptionDueDate]) =9 THEN SUM(GL.[Debit]) ELSE 0 END AS 'SEP' ,
	CASE WHEN DATEPART(MONTH,GL.[SubscriptionDueDate]) =10 THEN SUM(GL.[Debit]) ELSE 0 END AS 'OCT' ,
	CASE WHEN DATEPART(MONTH,GL.[SubscriptionDueDate]) =11 THEN SUM(GL.[Debit]) ELSE 0 END AS 'NOV' ,
	CASE WHEN DATEPART(MONTH,GL.[SubscriptionDueDate]) =12 THEN SUM(GL.[Debit]) ELSE 0 END AS 'DEC',
	SUM(GL.[Debit]) AS TOTDUE
FROM 
	[Acc_GL] AS GL
INNER JOIN [Customer] AS CST ON CST.[Id] = GL.[CustId] AND CST.[TypeId] = 2
WHERE
	GL.[CoaId] = 10 AND GL.[TranTypeId] = 5 AND GL.[IsPostpaid] = 1 AND GL.[IsActive] = 1
	AND DATEPART(YEAR,GL.[SubscriptionDueDate]) = @year
GROUP BY
	CST.[Id] ,CST.[FirstName],CST.[LastName],DATEPART(MONTH,GL.[SubscriptionDueDate])
	

) AS SUBDUE
GROUP BY
SUBDUE.[Id] ,SUBDUE.FirstName
) AS TBLDUE
ON TBLPAID.[Id] = TBLDUE.[Id] 
RIGHT JOIN [Customer] AS CST ON CST.[Id] = TBLDUE.[Id] AND CST.[TypeId]= 2
INNER JOIN [Subscription] AS SUBS ON SUBS.[CustId] = CST.[Id]
GROUP BY
	CST.[Id] ,CST.[FirstName] ,CST.[LastName],SUBS.DueDate,SUBS.SubscriptionAmount
END
